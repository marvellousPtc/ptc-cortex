# éƒ¨ç½²åˆ°è‡ªæœ‰æœåŠ¡å™¨ï¼ˆGitHub æ„å»º + SSH éƒ¨ç½²ï¼‰
name: Deploy to Server

on:
  push:
    branches: [main]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: å®‰è£… Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: å®‰è£…ä¾èµ–
        run: pnpm install

      - name: æ„å»ºé¡¹ç›®
        run: pnpm next build
        env:
          # æ„å»ºæ—¶éœ€è¦ basePath
          NEXT_PUBLIC_BASE_PATH: /chat
          # better-sqlite3 åœ¨ CI é‡Œç¼–è¯‘å¯èƒ½æ¶æ„ä¸åŒï¼Œ
          # ä½† Next.js build åªåšä»£ç æ‰“åŒ…ï¼Œè¿è¡Œæ—¶åœ¨æœåŠ¡å™¨ä¸Š rebuild
          DEEPSEEK_API_KEY: placeholder
          DEEPSEEK_BASE_URL: https://api.deepseek.com

      - name: æ‰“åŒ…éƒ¨ç½²æ–‡ä»¶
        run: |
          mkdir -p deploy
          cp -r .next deploy/.next
          cp -r public deploy/public
          cp -r src deploy/src
          cp package.json deploy/
          cp pnpm-lock.yaml deploy/
          cp ecosystem.config.js deploy/
          cp next.config.ts deploy/
          cp tsconfig.json deploy/
          # åˆ é™¤ä¸éœ€è¦çš„ç¼“å­˜ï¼ˆå‡å°åŒ…ä½“ç§¯ï¼‰
          rm -rf deploy/.next/cache
          # æ‰“åŒ…
          tar -czf deploy.tar.gz -C deploy .

      - name: ä¸Šä¼ éƒ¨ç½²åŒ…åˆ°æœåŠ¡å™¨
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: "deploy.tar.gz"
          target: "/tmp"

      - name: è§£å‹å¹¶é‡å¯æœåŠ¡
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          command_timeout: 10m
          script: |
            PROJECT_PATH="${{ secrets.CORTEX_PROJECT_PATH || '/ptc/ptc-cortex' }}"

            # ====== ç¡®ä¿æœ‰ swapï¼ˆå°å†…å­˜æœåŠ¡å™¨å¿…å¤‡ï¼‰======
            if [ ! -f /swapfile ]; then
              echo "ğŸ“¦ åˆ›å»º 2G swap..."
              sudo fallocate -l 2G /swapfile
              sudo chmod 600 /swapfile
              sudo mkswap /swapfile
              sudo swapon /swapfile
              echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
            fi
            # ç¡®ä¿ swap å·²å¯ç”¨
            sudo swapon /swapfile 2>/dev/null || true

            # ====== å…ˆåœæ‰ ptc-cortex é‡Šæ”¾å†…å­˜ ======
            if pm2 describe ptc-cortex > /dev/null 2>&1; then
              pm2 stop ptc-cortex
            fi

            # å¤‡ä»½ .env.localï¼ˆå« API å¯†é’¥ï¼Œä¸èƒ½ä¸¢ï¼‰
            if [ -f "$PROJECT_PATH/.env.local" ]; then
              cp "$PROJECT_PATH/.env.local" /tmp/.env.local.backup
            fi

            # å¤‡ä»½ data ç›®å½•ï¼ˆSQLite æ•°æ®åº“ï¼Œå¿…é¡»æŒä¹…åŒ–ï¼‰
            if [ -d "$PROJECT_PATH/data" ]; then
              cp -r "$PROJECT_PATH/data" /tmp/cortex-data-backup
            fi

            # å¤‡ä»½ä¸Šä¼ æ–‡ä»¶ç›®å½•
            if [ -d "$PROJECT_PATH/public/uploads" ]; then
              cp -r "$PROJECT_PATH/public/uploads" /tmp/cortex-uploads-backup
            fi

            # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
            mkdir -p "$PROJECT_PATH"

            # æ¸…ç©ºç›®æ ‡ç›®å½•
            rm -rf "$PROJECT_PATH"/*
            rm -rf "$PROJECT_PATH"/.[!.]*

            # è§£å‹æ–°æ–‡ä»¶
            tar -xzf /tmp/deploy.tar.gz -C "$PROJECT_PATH"

            # æ¢å¤ .env.local
            if [ -f "/tmp/.env.local.backup" ]; then
              mv /tmp/.env.local.backup "$PROJECT_PATH/.env.local"
            fi

            # æ¢å¤ data ç›®å½•ï¼ˆSQLite æ•°æ®åº“ï¼‰
            if [ -d "/tmp/cortex-data-backup" ]; then
              rm -rf "$PROJECT_PATH/data"
              mv /tmp/cortex-data-backup "$PROJECT_PATH/data"
            fi

            # æ¢å¤ä¸Šä¼ æ–‡ä»¶
            if [ -d "/tmp/cortex-uploads-backup" ]; then
              rm -rf "$PROJECT_PATH/public/uploads"
              mv /tmp/cortex-uploads-backup "$PROJECT_PATH/public/uploads"
            fi

            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f /tmp/deploy.tar.gz

            cd "$PROJECT_PATH"

            # å®‰è£…ä¾èµ–ï¼ˆé™åˆ¶å†…å­˜ï¼Œé˜²æ­¢ OOMï¼‰
            NODE_OPTIONS="--max-old-space-size=512" pnpm install --prod

            # é‡æ–°ç¼–è¯‘åŸç”Ÿæ¨¡å—ï¼ˆç¡®ä¿å’ŒæœåŠ¡å™¨æ¶æ„åŒ¹é…ï¼‰
            pnpm rebuild better-sqlite3

            # é‡å¯ PM2
            if pm2 describe ptc-cortex > /dev/null 2>&1; then
              pm2 reload ecosystem.config.js --update-env
            else
              pm2 start ecosystem.config.js
            fi
            pm2 save

            echo "âœ… ptc-cortex éƒ¨ç½²å®Œæˆï¼"
