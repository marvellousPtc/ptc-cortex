{
  "title": "为 TipTap 编辑器添加表格支持与 Markdown 粘贴转换",
  "content": "## 背景\n\n在使用 TipTap 富文本编辑器时，遇到了两个常见的痛点：\n\n1. **无法插入和编辑表格** - 很多技术文档需要用表格展示数据，但编辑器不支持\n2. **无法粘贴 Markdown** - 从其他地方复制的 Markdown 文本粘贴进来只是纯文本，需要手动重新格式化\n\n这两个问题严重影响了写作效率，特别是在撰写技术博客时。\n\n## 技术方案\n\n### 表格支持\n\nTipTap 官方提供了 `@tiptap/extension-table` 系列扩展，包括：\n\n- `@tiptap/extension-table` - 表格主扩展\n- `@tiptap/extension-table-row` - 表格行\n- `@tiptap/extension-table-cell` - 表格单元格\n- `@tiptap/extension-table-header` - 表头单元格\n\n### Markdown 粘贴转换\n\n使用 `marked` 库解析 Markdown，配合智能检测逻辑：\n\n1. 检测粘贴内容是否为 Markdown 格式\n2. 如果是，转换为 HTML 后插入编辑器\n3. 如果已有富文本格式，保持原样\n\n## 实现细节\n\n### 1. 配置表格扩展\n\n```typescript\nimport { Table } from '@tiptap/extension-table';\nimport { TableRow } from '@tiptap/extension-table-row';\nimport { TableCell } from '@tiptap/extension-table-cell';\nimport { TableHeader } from '@tiptap/extension-table-header';\n\nconst editor = useEditor({\n  extensions: [\n    // ...其他扩展\n    Table.configure({\n      resizable: true,           // 启用列宽调整\n      lastColumnResizable: true, // 最后一列也可调整\n      allowTableNodeSelection: true,\n    }),\n    TableRow,\n    TableHeader,\n    TableCell,\n  ],\n});\n```\n\n关键配置：\n- `resizable: true` 让用户可以拖动列边缘调整宽度\n- 需要配合 CSS 样式显示调整手柄\n\n### 2. Markdown 检测逻辑\n\n```typescript\nconst isMarkdownText = (text: string): boolean => {\n  const markdownPatterns = [\n    /^#{1,6}\\s+.+$/m,        // 标题\n    /^\\s*[-*+]\\s+.+$/m,      // 无序列表\n    /\\*\\*[^*]+\\*\\*/,         // 粗体\n    /`[^`]+`/,               // 行内代码\n    /```[\\s\\S]*?```/,        // 代码块\n    /^\\s*>\\s+.+$/m,          // 引用\n    /\\[.+\\]\\(.+\\)/,          // 链接\n    /^\\|.+\\|$/m,             // 表格\n  ];\n  \n  let matchCount = 0;\n  for (const pattern of markdownPatterns) {\n    if (pattern.test(text)) {\n      matchCount++;\n      if (matchCount >= 2) return true;\n    }\n  }\n  return false;\n};\n```\n\n设计思路：要求至少匹配 2 个模式才认定为 Markdown，避免误判普通文本。\n\n### 3. 粘贴事件处理\n\n```typescript\nconst handlePaste = async (event: ClipboardEvent) => {\n  const plainText = event.clipboardData?.getData('text/plain');\n  const htmlText = event.clipboardData?.getData('text/html');\n\n  if (plainText && isMarkdownText(plainText)) {\n    // 检查是否已有富文本格式\n    if (htmlText) {\n      const hasRichFormatting = /<(table|strong|em|pre)[^>]*>/i.test(htmlText);\n      if (hasRichFormatting) return; // 让 TipTap 默认处理\n    }\n\n    event.preventDefault();\n    const html = await marked.parse(plainText);\n    editor.chain().focus().insertContent(html).run();\n  }\n};\n```\n\n### 4. 表格样式\n\n```css\n.tiptap table {\n  border-collapse: collapse;\n  table-layout: fixed;\n  width: 100%;\n  border: 2px solid var(--border);\n}\n\n.tiptap td, .tiptap th {\n  border: 1px solid var(--border);\n  padding: 0.6rem 0.8rem;\n  min-width: 50px;\n}\n\n.tiptap .column-resize-handle {\n  background-color: var(--primary);\n  width: 4px;\n  cursor: col-resize;\n}\n```\n\n## 踩过的坑\n\n1. **表格扩展版本不匹配** - 需要使用命名导出 `{ Table }` 而非默认导出\n2. **`display: block` 破坏表格布局** - 之前为了实现滚动用了这个属性，导致表格无法正常显示\n3. **边框在亮色模式下不可见** - 需要使用 `--border` 变量而非 `--card-border`\n\n## 总结\n\n通过这次改动：\n\n- 编辑器现在支持插入、编辑表格，并可拖动调整列宽\n- 从外部复制的 Markdown 内容可以自动转换为富文本\n- 工具栏新增表格操作按钮（添加/删除行列）\n\n这大大提升了技术写作的效率，特别是在处理包含表格和代码的文档时。",
  "tags": ["TipTap", "React", "富文本编辑器", "Markdown"],
  "published": false
}
